<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/layout :: head('Proyectos - RRHH')}">
    <title>Proyectos - RRHH</title>
</head>
<body>
<header th:replace="~{fragments/layout :: header(${#authentication.name})}"></header>

<div class="container mt-4">
    <h2>Gestión de Proyectos</h2>

    <div th:replace="~{fragments/layout :: messages}"></div>

    <!-- Pestañas para navegar entre secciones -->
    <ul class="nav nav-tabs mb-4" id="proyectosTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="lista-tab" data-bs-toggle="tab" data-bs-target="#lista"
                    type="button" role="tab" aria-controls="lista" aria-selected="true">
                Lista de Proyectos
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="horas-tab" data-bs-toggle="tab" data-bs-target="#horas"
                    type="button" role="tab" aria-controls="horas" aria-selected="false">
                Horas por Proyecto
            </button>
        </li>
    </ul>

    <!-- Contenido de las pestañas -->
    <div class="tab-content" id="proyectosTabContent">
        <!-- Pestaña: Lista de Proyectos -->
        <div class="tab-pane fade show active" id="lista" role="tabpanel" aria-labelledby="lista-tab">
            <div class="alert alert-info" th:if="${proyectos != null && proyectos.empty}">
                No hay proyectos disponibles en este momento.
            </div>

            <div class="table-responsive" th:if="${proyectos != null && !proyectos.empty}">
                <table class="table table-striped">
                    <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Fecha Inicio</th>
                        <th>Fecha Fin Estimada</th>
                        <th>Estado</th>
                        <th>Presupuesto</th>
                        <th>Acciones</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="proyecto : ${proyectos}">
                        <td th:text="${proyecto.id}"></td>
                        <td th:text="${proyecto.nombre}"></td>
                        <td th:text="${#temporals.format(proyecto.fechaInicio, 'dd/MM/yyyy')}"></td>
                        <td th:text="${#temporals.format(proyecto.fechaFinEstimada, 'dd/MM/yyyy')}"></td>
                        <td>
                            <span th:class="${proyecto.estado == 'PLANIFICACION' ? 'badge bg-warning' :
                                            (proyecto.estado == 'EN_PROGRESO' ? 'badge bg-primary' :
                                            (proyecto.estado == 'COMPLETADO' ? 'badge bg-success' : 'badge bg-secondary'))}"
                                  th:text="${proyecto.estado}"></span>
                        </td>
                        <td th:text="${proyecto.presupuesto != null ? proyecto.presupuesto + ' €' : 'No asignado'}"></td>
                        <td>
                            <a th:href="@{/rrhh/proyectos/{id}/horas(id=${proyecto.id})}" class="btn btn-info btn-sm">Ver Horas</a>
                            <a th:href="@{/rrhh/presupuestos/crear/{id}(id=${proyecto.id})}" class="btn btn-primary btn-sm">
                                Crear Presupuesto
                            </a>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <div class="mt-3">
                <a th:href="@{/dashboard}" class="btn btn-secondary">Volver al Dashboard</a>
            </div>
        </div>

        <!-- Pestaña: Horas por Proyecto -->
        <div class="tab-pane fade" id="horas" role="tabpanel" aria-labelledby="horas-tab">
            <div class="alert alert-info" th:if="${proyectos != null && proyectos.empty}">
                No hay proyectos con horas registradas disponibles.
            </div>

            <div class="table-responsive" th:if="${proyectos != null && !proyectos.empty}">
                <table class="table table-striped">
                    <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre del Proyecto</th>
                        <th>Fecha Inicio</th>
                        <th>Fecha Fin</th>
                        <th>Total Horas</th>
                        <th>Acciones</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="proyecto : ${proyectos}">
                        <td th:text="${proyecto.id}"></td>
                        <td th:text="${proyecto.nombre}"></td>
                        <td th:text="${#temporals.format(proyecto.fechaInicio, 'dd/MM/yyyy')}"></td>
                        <td th:text="${proyecto.fechaFinReal != null ? #temporals.format(proyecto.fechaFinReal, 'dd/MM/yyyy') : 'En curso'}"></td>
                        <td th:text="${horasPorProyecto != null ? horasPorProyecto[proyecto.id] : '0'} + ' h'"></td>
                        <td>
                            <a th:href="@{/rrhh/proyectos/{id}/horas(id=${proyecto.id})}" class="btn btn-info btn-sm">
                                Ver Detalle Horas
                            </a>
                            <a th:href="@{/rrhh/presupuestos/crear/{id}(id=${proyecto.id})}" class="btn btn-primary btn-sm">
                                Crear Presupuesto
                            </a>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <div class="mt-3">
                <a th:href="@{/dashboard}" class="btn btn-secondary">Volver al Dashboard</a>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap Bundle with Popper -->
<script th:src="@{/webjars/bootstrap/5.3.2/js/bootstrap.bundle.min.js}"></script>

<!-- Script para mantener la pestaña activa después de recargar la página -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Recuperar la pestaña activa del almacenamiento local
        const activeTab = localStorage.getItem('proyectosActiveTab');

        if (activeTab) {
            const tab = new bootstrap.Tab(document.querySelector('#proyectosTab button[data-bs-target="' + activeTab + '"]'));
            tab.show();
        }

        // Guardar la pestaña activa cuando se cambia
        document.querySelectorAll('#proyectosTab button').forEach(button => {
            button.addEventListener('shown.bs.tab', function(event) {
                localStorage.setItem('proyectosActiveTab', event.target.getAttribute('data-bs-target'));
            });
        });
    });
</script>
</body>
</html>
